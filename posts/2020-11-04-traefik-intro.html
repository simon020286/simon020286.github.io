<!DOCTYPE html><html lang="en"><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><script>!function(){try{var d=document.documentElement.classList;d.remove('light','dark');var e=localStorage.getItem("theme");if(e){d.add(e)}else{d.add('dark');}}catch(t){}}();</script><title>Traefik - Intro - T-Dev</title><meta content="Introduzione a traefik" name="description"/><meta property="og:url" content="https://simon020286.github.io/posts/2020-11-04-traefik-intro"/><link rel="canonical" href="https://simon020286.github.io/posts/2020-11-04-traefik-intro"/><meta property="og:type" content="article"/><meta property="og:site_name" content="Traefik - Intro"/><meta property="og:description" content="Introduzione a traefik"/><meta property="og:title" content="Traefik - Intro"/><meta property="og:image" content="https://nextjs-typescript-mdx-blog.vercel.appundefined"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:site" content="@huntarosan"/><meta name="twitter:title" content="Traefik - Intro"/><meta name="twitter:description" content="Introduzione a traefik"/><meta name="twitter:image" content="https://nextjs-typescript-mdx-blog.vercel.appundefined"/><meta property="article:published_time" content="Tue Nov 10 2020"/><meta name="next-head-count" content="18"/><link rel="preload" href="./_next/static/css/c5987b51c198f1d093cc.css" as="style"/><link rel="stylesheet" href="./_next/static/css/c5987b51c198f1d093cc.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="./_next/static/chunks/polyfills-a40ef1678bae11e696dba45124eadd70.js"></script><script src="./_next/static/chunks/webpack-1856074edfcdd1518f76.js" defer=""></script><script src="./_next/static/chunks/framework-895f067827ebe11ffe45.js" defer=""></script><script src="./_next/static/chunks/main-1f2c591c5d3bfcfc95e6.js" defer=""></script><script src="./_next/static/chunks/pages/_app-a14dd6af74b8559dafb5.js" defer=""></script><script src="./_next/static/chunks/838-292b52a783d0bfb7b58f.js" defer=""></script><script src="./_next/static/chunks/384-52a5c121222f81fe3d13.js" defer=""></script><script src="./_next/static/chunks/pages/posts/%5Bslug%5D-4401efa11930ab4a9e32.js" defer=""></script><script src="./_next/static/s30i1eaifIS6S8HLH4iJD/_buildManifest.js" defer=""></script><script src="./_next/static/s30i1eaifIS6S8HLH4iJD/_ssgManifest.js" defer=""></script><style id="__jsx-1084485634">html,body,body>div:first-child,div#__next,div#__next>div{height:100%;}</style></head><body class="bg-white dark:bg-black text-gray-900 dark:text-white"><div id="__next"><div class="flex flex-col min-h-screen"><header><div class="max-w-5xl px-8 mx-auto"><div class="flex items-center justify-between py-6"><nav><a class="text-gray-900 dark:text-white pr-6 py-4" href="/">Home</a><a class="text-gray-900 dark:text-white px-6 py-4" href="/tags">Tags</a></nav></div></div></header><main class="mb-0 flex-grow"><div class="max-w-5xl px-8 py-4 mx-auto"><article><h1 class="mb-3 text-gray-900 dark:text-white">Traefik - Intro</h1><p class="mb-10 text-sm text-gray-500 dark:text-gray-400">November 10, 2020</p><div class="prose dark:prose-dark"><p>Buongiorno,<br/>
<!-- -->oggi parleremo da <a href="https://doc.traefik.io/traefik/">Traefik</a>, un HTTP reverse proxy e load balancer.</p><p><img src="https://doc.traefik.io/traefik/v1.7/img/architecture.png" alt="architettura"/></p><p>Io lo sto utilizzando per rendere accessibili dall&#x27;esterno dei servizi hostati sul mio nas, come ad esempio Home Assistant e l&#x27;ottimo password manager Bitwarden (di cui probabilmente parlerò su questo blog).<br/>
<!-- -->Si integra perfettamente con docker, è infatti in grado di leggere automaticamente le impostazioni da un container tramite label.<br/>
<!-- -->Vediamo ora come installarlo proprio tramite docker, più precisamente utilizzando docker-compose per semplificare le cose.</p><p>Per prima cosa scriviamo il file di configurazione. Ci sono vari modi per configurare Traefik, via argomenti da linea di comando o via file traefik.yml, che è la strada che ho scelto io perché mi sembra più chiara. Ho commentato direttamente nel file le parti &quot;meno&quot; importanti.</p><pre class="language-yaml"><code class="language-yaml"><span class="token punctuation">---</span>
<span class="token key atrule">global</span><span class="token punctuation">:</span>
  <span class="token comment"># Verifica la presenza di nuove versioni.</span>
  <span class="token key atrule">checkNewVersion</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>

<span class="token key atrule">entryPoints</span><span class="token punctuation">:</span>
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
    <span class="token key atrule">address</span><span class="token punctuation">:</span> <span class="token punctuation">:</span><span class="token number">80</span>
    <span class="token key atrule">forwardedHeaders</span><span class="token punctuation">:</span>
      <span class="token key atrule">insecure</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">proxyProtocol</span><span class="token punctuation">:</span>
      <span class="token key atrule">insecure</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">https</span><span class="token punctuation">:</span>
    <span class="token key atrule">address</span><span class="token punctuation">:</span> <span class="token punctuation">:</span><span class="token number">443</span>
    <span class="token key atrule">forwardedHeaders</span><span class="token punctuation">:</span>
      <span class="token key atrule">insecure</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">proxyProtocol</span><span class="token punctuation">:</span>
      <span class="token key atrule">insecure</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>

<span class="token key atrule">providers</span><span class="token punctuation">:</span>
  <span class="token key atrule">docker</span><span class="token punctuation">:</span>
    <span class="token key atrule">watch</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">exposedByDefault</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
    <span class="token key atrule">endpoint</span><span class="token punctuation">:</span> <span class="token string">&#x27;unix:///var/run/docker.sock&#x27;</span>
  <span class="token key atrule">file</span><span class="token punctuation">:</span>
    <span class="token key atrule">directory</span><span class="token punctuation">:</span> <span class="token string">&#x27;/etc/traefik/dynamic/&#x27;</span>
    <span class="token key atrule">watch</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>

<span class="token key atrule">api</span><span class="token punctuation">:</span>
  <span class="token comment"># Visualizza l&#x27;interfaccia web della dashboard e permetti connessioni non sicure.</span>
  <span class="token key atrule">dashboard</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">insecure</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>

<span class="token comment"># Salva il log nel percorso specificato, con livello DEBUG.</span>
<span class="token comment"># Ovviamente una volta impostato e verificato il corretto funzionamento si può abbassare il livello.</span>
<span class="token key atrule">log</span><span class="token punctuation">:</span>
  <span class="token key atrule">filePath</span><span class="token punctuation">:</span> <span class="token string">&#x27;/shared/logs/traefik/traefik.log&#x27;</span>
  <span class="token key atrule">level</span><span class="token punctuation">:</span> DEBUG

<span class="token comment"># Salva il log delle chiamate nel percorso specificato.</span>
<span class="token comment"># E&#x27; possibile specificare dei filtri, nel mio caso solo le chiamate con condici di errore.</span>
<span class="token key atrule">accessLog</span><span class="token punctuation">:</span>
  <span class="token key atrule">filePath</span><span class="token punctuation">:</span> <span class="token string">&#x27;/shared/logs/traefik/access.log&#x27;</span>
  <span class="token key atrule">filters</span><span class="token punctuation">:</span>
    <span class="token key atrule">statusCodes</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&#x27;400-599&#x27;</span><span class="token punctuation">]</span>

<span class="token comment"># Let&#x27;s encrypt configuration</span>
<span class="token key atrule">certificatesResolvers</span><span class="token punctuation">:</span>
  <span class="token key atrule">le</span><span class="token punctuation">:</span>
    <span class="token key atrule">acme</span><span class="token punctuation">:</span>
      <span class="token key atrule">email</span><span class="token punctuation">:</span> &lt;email<span class="token punctuation">&gt;</span>
      <span class="token key atrule">storage</span><span class="token punctuation">:</span> /etc/traefik/acme/acme.json
      <span class="token key atrule">tlschallenge</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre><p>Per prima cosa vengono definiti gli entry points sono i punti di ingresso che può accettare il nostro proxy.<br/>
<!-- -->Io mi attendo delle connessioni dalla porta 80 e 443, è possibile aggiungere molte altre opzioni, ma per questo approfondimento vi rimando alla guida ufficiale.<br/>
<!-- -->I providers sono le risorse da cui è possibile accettare le configurazioni dinamiche, ossia i servizi, le routers e i middlewares.</p><ul><li><p>docker: permette di creare delle configurazioni tramite le labels di un container.</p><ul><li>watch: true indica a traefik di rimanere in ascolto di modifiche sui containers, così non sarà necessario riavviare il server ad ogni modifica.</li><li>exposedByDefault: false, bisogna specificare in un container se esporlo a traefik, altrimenti per ogni nuovo container in esecuzione verrà creato un servizio.</li><li>endpoint: &quot;unix:///var/run/docker.sock&quot; il percorso del sock di docker per permettere la comunicazione con esso. Nel nostro caso sarà l&#x27;istanza di docker installata sul sistema host, come vedremo in seguito.</li></ul></li><li><p>file: permette di creare le configurazioni tramite file o files yaml o toml.</p><ul><li>directory: &quot;/etc/traefik/dynamic/&quot; ho optato per indicare una cartella in modo da poter suddividere in modo più ordinato le impostazioni. E&#x27; possibili anche indicare un singolo file tramite l&#x27;impostazione <code>filename</code>.</li><li>watch: true come sopra.</li></ul></li></ul><p>L&#x27;altra parte molto importante del file è <code>certificatesResolvers</code>, cioè il modo in cui risolvere i certificati SSL.<br/>
<!-- -->Nel mio caso utilizzo Let&#x27;s Encrypt, un servizio gratuito che permette la generazione di certificati. Traefik integra già tutto il funzionamento basta utilizzare come provider <code>acme</code>. Le altre impostazioni sono molto semplici, una email valida per ricevere avvisi di scadenza dei certificati e il percorso dove salvare gli stessi.</p><p>Definita la configurazione base possiamo passare alla creazione del file docker-compose.yml per la creazione del container.</p><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">&#x27;3&#x27;</span>

<span class="token key atrule">networks</span><span class="token punctuation">:</span>
  <span class="token key atrule">trproxy</span><span class="token punctuation">:</span>
    <span class="token key atrule">driver</span><span class="token punctuation">:</span> bridge

<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">traefik</span><span class="token punctuation">:</span>
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> traefik
    <span class="token key atrule">image</span><span class="token punctuation">:</span> traefik<span class="token punctuation">:</span>latest
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> unless<span class="token punctuation">-</span>stopped
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> trproxy
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> TZ<span class="token punctuation">:</span><span class="token string">&quot;Europe/Rome&quot;</span>
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 8080<span class="token punctuation">:</span><span class="token number">8080</span>
      <span class="token punctuation">-</span> <span class="token datetime number">80:80</span>
      <span class="token punctuation">-</span> 443<span class="token punctuation">:</span><span class="token number">443</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /var/run/docker.sock<span class="token punctuation">:</span>/var/run/docker.sock<span class="token punctuation">:</span>ro
      <span class="token punctuation">-</span> &lt;dir<span class="token punctuation">&gt;</span>/traefik.yml<span class="token punctuation">:</span>/etc/traefik/traefik.yml<span class="token punctuation">:</span>ro
      <span class="token punctuation">-</span> &lt;dir<span class="token punctuation">&gt;</span>/dynamic<span class="token punctuation">:</span>/etc/traefik/dynamic/<span class="token punctuation">:</span>ro
      <span class="token punctuation">-</span> &lt;dir<span class="token punctuation">&gt;</span>/acme/acme.json<span class="token punctuation">:</span>/etc/traefik/acme/acme.json
      <span class="token punctuation">-</span> &lt;dir<span class="token punctuation">&gt;</span>/shared<span class="token punctuation">:</span>/shared
</code></pre><p>Per prima cosa viene definita la connessione, verrà utilizzata dai containers che vogliono collegarsi a traeik.<br/>
<!-- -->Le tre porte esposte sono:</p><ul><li>8080 dedicata alla dashboard</li><li>80 per le connessioni non sicure</li><li>443 per le connessioni sicure</li></ul><p>I volumi invece:</p><ul><li>/var/run/docker.sock percorso sock docker installato sull&#x27;host</li></ul><p>Scritto il file <code>docker-compose.yml</code> lanciamo il servizio con <code>docker-compose up -d</code>. In base alla connessione e potenza della macchina host ci può volere anche qualche minuto. Quando sarà tutto finito potrete raggiungere la dashboard da browser tramite http:<!-- -->\<!-- -->\<!-- -->&lt; ip della macchina su cui lo avete installato&gt;:8080.<br/>
<!-- -->Saranno già presenti un paio di servizi, tranquilli sono quelli interni che vengono creati dal proxy.</p><p>Con questo la piccola guida è finita.<br/>
<!-- -->Spero di esservi stato utile.</p></div></article></div></main><footer class="py-8"><div class="max-w-5xl px-8 mx-auto">Built by T-Dev</div></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"source":{"compiledSource":"var l=Object.defineProperty,N=Object.defineProperties;var u=Object.getOwnPropertyDescriptors;var o=Object.getOwnPropertySymbols;var p=Object.prototype.hasOwnProperty,c=Object.prototype.propertyIsEnumerable;var r=(e,n,s)=\u003en in e?l(e,n,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[n]=s,a=(e,n)=\u003e{for(var s in n||(n={}))p.call(n,s)\u0026\u0026r(e,s,n[s]);if(o)for(var s of o(n))c.call(n,s)\u0026\u0026r(e,s,n[s]);return e},i=(e,n)=\u003eN(e,u(n));var m=(e,n)=\u003e{var s={};for(var t in e)p.call(e,t)\u0026\u0026n.indexOf(t)\u003c0\u0026\u0026(s[t]=e[t]);if(e!=null\u0026\u0026o)for(var t of o(e))n.indexOf(t)\u003c0\u0026\u0026c.call(e,t)\u0026\u0026(s[t]=e[t]);return s};const layoutProps={},MDXLayout=\"wrapper\";function MDXContent(s){var t=s,{components:e}=t,n=m(t,[\"components\"]);return mdx(MDXLayout,i(a(a({},layoutProps),n),{components:e,mdxType:\"MDXLayout\"}),mdx(\"p\",null,\"Buongiorno,\",mdx(\"br\",{parentName:\"p\"}),`\n`,\"oggi parleremo da \",mdx(\"a\",a({parentName:\"p\"},{href:\"https://doc.traefik.io/traefik/\"}),\"Traefik\"),\", un HTTP reverse proxy e load balancer.\"),mdx(\"p\",null,mdx(\"img\",a({parentName:\"p\"},{src:\"https://doc.traefik.io/traefik/v1.7/img/architecture.png\",alt:\"architettura\"}))),mdx(\"p\",null,\"Io lo sto utilizzando per rendere accessibili dall'esterno dei servizi hostati sul mio nas, come ad esempio Home Assistant e l'ottimo password manager Bitwarden (di cui probabilmente parler\\xF2 su questo blog).\",mdx(\"br\",{parentName:\"p\"}),`\n`,\"Si integra perfettamente con docker, \\xE8 infatti in grado di leggere automaticamente le impostazioni da un container tramite label.\",mdx(\"br\",{parentName:\"p\"}),`\n`,\"Vediamo ora come installarlo proprio tramite docker, pi\\xF9 precisamente utilizzando docker-compose per semplificare le cose.\"),mdx(\"p\",null,'Per prima cosa scriviamo il file di configurazione. Ci sono vari modi per configurare Traefik, via argomenti da linea di comando o via file traefik.yml, che \\xE8 la strada che ho scelto io perch\\xE9 mi sembra pi\\xF9 chiara. Ho commentato direttamente nel file le parti \"meno\" importanti.'),mdx(\"pre\",a({},{className:\"language-yaml\"}),mdx(\"code\",a({parentName:\"pre\"},{className:\"language-yaml\"}),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"---\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token key atrule\"}),\"global\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),`\n  `,mdx(\"span\",a({parentName:\"code\"},{className:\"token comment\"}),\"# Verifica la presenza di nuove versioni.\"),`\n  `,mdx(\"span\",a({parentName:\"code\"},{className:\"token key atrule\"}),\"checkNewVersion\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token boolean important\"}),\"true\"),`\n\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token key atrule\"}),\"entryPoints\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),`\n  `,mdx(\"span\",a({parentName:\"code\"},{className:\"token key atrule\"}),\"http\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),`\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token key atrule\"}),\"address\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token number\"}),\"80\"),`\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token key atrule\"}),\"forwardedHeaders\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),`\n      `,mdx(\"span\",a({parentName:\"code\"},{className:\"token key atrule\"}),\"insecure\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token boolean important\"}),\"true\"),`\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token key atrule\"}),\"proxyProtocol\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),`\n      `,mdx(\"span\",a({parentName:\"code\"},{className:\"token key atrule\"}),\"insecure\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token boolean important\"}),\"true\"),`\n  `,mdx(\"span\",a({parentName:\"code\"},{className:\"token key atrule\"}),\"https\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),`\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token key atrule\"}),\"address\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token number\"}),\"443\"),`\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token key atrule\"}),\"forwardedHeaders\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),`\n      `,mdx(\"span\",a({parentName:\"code\"},{className:\"token key atrule\"}),\"insecure\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token boolean important\"}),\"true\"),`\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token key atrule\"}),\"proxyProtocol\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),`\n      `,mdx(\"span\",a({parentName:\"code\"},{className:\"token key atrule\"}),\"insecure\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token boolean important\"}),\"true\"),`\n\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token key atrule\"}),\"providers\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),`\n  `,mdx(\"span\",a({parentName:\"code\"},{className:\"token key atrule\"}),\"docker\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),`\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token key atrule\"}),\"watch\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token boolean important\"}),\"true\"),`\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token key atrule\"}),\"exposedByDefault\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token boolean important\"}),\"false\"),`\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token key atrule\"}),\"endpoint\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token string\"}),\"'unix:///var/run/docker.sock'\"),`\n  `,mdx(\"span\",a({parentName:\"code\"},{className:\"token key atrule\"}),\"file\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),`\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token key atrule\"}),\"directory\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token string\"}),\"'/etc/traefik/dynamic/'\"),`\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token key atrule\"}),\"watch\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token boolean important\"}),\"true\"),`\n\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token key atrule\"}),\"api\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),`\n  `,mdx(\"span\",a({parentName:\"code\"},{className:\"token comment\"}),\"# Visualizza l'interfaccia web della dashboard e permetti connessioni non sicure.\"),`\n  `,mdx(\"span\",a({parentName:\"code\"},{className:\"token key atrule\"}),\"dashboard\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token boolean important\"}),\"true\"),`\n  `,mdx(\"span\",a({parentName:\"code\"},{className:\"token key atrule\"}),\"insecure\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token boolean important\"}),\"true\"),`\n\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token comment\"}),\"# Salva il log nel percorso specificato, con livello DEBUG.\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token comment\"}),\"# Ovviamente una volta impostato e verificato il corretto funzionamento si pu\\xF2 abbassare il livello.\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token key atrule\"}),\"log\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),`\n  `,mdx(\"span\",a({parentName:\"code\"},{className:\"token key atrule\"}),\"filePath\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token string\"}),\"'/shared/logs/traefik/traefik.log'\"),`\n  `,mdx(\"span\",a({parentName:\"code\"},{className:\"token key atrule\"}),\"level\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),` DEBUG\n\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token comment\"}),\"# Salva il log delle chiamate nel percorso specificato.\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token comment\"}),\"# E' possibile specificare dei filtri, nel mio caso solo le chiamate con condici di errore.\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token key atrule\"}),\"accessLog\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),`\n  `,mdx(\"span\",a({parentName:\"code\"},{className:\"token key atrule\"}),\"filePath\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token string\"}),\"'/shared/logs/traefik/access.log'\"),`\n  `,mdx(\"span\",a({parentName:\"code\"},{className:\"token key atrule\"}),\"filters\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),`\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token key atrule\"}),\"statusCodes\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"[\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token string\"}),\"'400-599'\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"]\"),`\n\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token comment\"}),\"# Let's encrypt configuration\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token key atrule\"}),\"certificatesResolvers\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),`\n  `,mdx(\"span\",a({parentName:\"code\"},{className:\"token key atrule\"}),\"le\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),`\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token key atrule\"}),\"acme\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),`\n      `,mdx(\"span\",a({parentName:\"code\"},{className:\"token key atrule\"}),\"email\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),\" \u003cemail\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"\u003e\"),`\n      `,mdx(\"span\",a({parentName:\"code\"},{className:\"token key atrule\"}),\"storage\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),` /etc/traefik/acme/acme.json\n      `,mdx(\"span\",a({parentName:\"code\"},{className:\"token key atrule\"}),\"tlschallenge\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token boolean important\"}),\"true\"),`\n`)),mdx(\"p\",null,\"Per prima cosa vengono definiti gli entry points sono i punti di ingresso che pu\\xF2 accettare il nostro proxy.\",mdx(\"br\",{parentName:\"p\"}),`\n`,\"Io mi attendo delle connessioni dalla porta 80 e 443, \\xE8 possibile aggiungere molte altre opzioni, ma per questo approfondimento vi rimando alla guida ufficiale.\",mdx(\"br\",{parentName:\"p\"}),`\n`,\"I providers sono le risorse da cui \\xE8 possibile accettare le configurazioni dinamiche, ossia i servizi, le routers e i middlewares.\"),mdx(\"ul\",null,mdx(\"li\",{parentName:\"ul\"},mdx(\"p\",{parentName:\"li\"},\"docker: permette di creare delle configurazioni tramite le labels di un container.\"),mdx(\"ul\",{parentName:\"li\"},mdx(\"li\",{parentName:\"ul\"},\"watch: true indica a traefik di rimanere in ascolto di modifiche sui containers, cos\\xEC non sar\\xE0 necessario riavviare il server ad ogni modifica.\"),mdx(\"li\",{parentName:\"ul\"},\"exposedByDefault: false, bisogna specificare in un container se esporlo a traefik, altrimenti per ogni nuovo container in esecuzione verr\\xE0 creato un servizio.\"),mdx(\"li\",{parentName:\"ul\"},`endpoint: \"unix:///var/run/docker.sock\" il percorso del sock di docker per permettere la comunicazione con esso. Nel nostro caso sar\\xE0 l'istanza di docker installata sul sistema host, come vedremo in seguito.`))),mdx(\"li\",{parentName:\"ul\"},mdx(\"p\",{parentName:\"li\"},\"file: permette di creare le configurazioni tramite file o files yaml o toml.\"),mdx(\"ul\",{parentName:\"li\"},mdx(\"li\",{parentName:\"ul\"},`directory: \"/etc/traefik/dynamic/\" ho optato per indicare una cartella in modo da poter suddividere in modo pi\\xF9 ordinato le impostazioni. E' possibili anche indicare un singolo file tramite l'impostazione `,mdx(\"inlineCode\",{parentName:\"li\"},\"filename\"),\".\"),mdx(\"li\",{parentName:\"ul\"},\"watch: true come sopra.\")))),mdx(\"p\",null,\"L'altra parte molto importante del file \\xE8 \",mdx(\"inlineCode\",{parentName:\"p\"},\"certificatesResolvers\"),\", cio\\xE8 il modo in cui risolvere i certificati SSL.\",mdx(\"br\",{parentName:\"p\"}),`\n`,\"Nel mio caso utilizzo Let's Encrypt, un servizio gratuito che permette la generazione di certificati. Traefik integra gi\\xE0 tutto il funzionamento basta utilizzare come provider \",mdx(\"inlineCode\",{parentName:\"p\"},\"acme\"),\". Le altre impostazioni sono molto semplici, una email valida per ricevere avvisi di scadenza dei certificati e il percorso dove salvare gli stessi.\"),mdx(\"p\",null,\"Definita la configurazione base possiamo passare alla creazione del file docker-compose.yml per la creazione del container.\"),mdx(\"pre\",a({},{className:\"language-yaml\"}),mdx(\"code\",a({parentName:\"pre\"},{className:\"language-yaml\"}),mdx(\"span\",a({parentName:\"code\"},{className:\"token key atrule\"}),\"version\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token string\"}),\"'3'\"),`\n\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token key atrule\"}),\"networks\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),`\n  `,mdx(\"span\",a({parentName:\"code\"},{className:\"token key atrule\"}),\"trproxy\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),`\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token key atrule\"}),\"driver\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),` bridge\n\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token key atrule\"}),\"services\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),`\n  `,mdx(\"span\",a({parentName:\"code\"},{className:\"token key atrule\"}),\"traefik\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),`\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token key atrule\"}),\"container_name\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),` traefik\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token key atrule\"}),\"image\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),\" traefik\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),`latest\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token key atrule\"}),\"restart\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),\" unless\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"-\"),`stopped\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token key atrule\"}),\"networks\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),`\n      `,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"-\"),` trproxy\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token key atrule\"}),\"environment\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),`\n      `,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"-\"),\" TZ\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token string\"}),'\"Europe/Rome\"'),`\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token key atrule\"}),\"ports\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),`\n      `,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"-\"),\" 8080\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token number\"}),\"8080\"),`\n      `,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"-\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token datetime number\"}),\"80:80\"),`\n      `,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"-\"),\" 443\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token number\"}),\"443\"),`\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token key atrule\"}),\"volumes\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),`\n      `,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"-\"),\" /var/run/docker.sock\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),\"/var/run/docker.sock\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),`ro\n      `,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"-\"),\" \u003cdir\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"\u003e\"),\"/traefik.yml\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),\"/etc/traefik/traefik.yml\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),`ro\n      `,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"-\"),\" \u003cdir\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"\u003e\"),\"/dynamic\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),\"/etc/traefik/dynamic/\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),`ro\n      `,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"-\"),\" \u003cdir\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"\u003e\"),\"/acme/acme.json\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),`/etc/traefik/acme/acme.json\n      `,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"-\"),\" \u003cdir\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"\u003e\"),\"/shared\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),`/shared\n`)),mdx(\"p\",null,\"Per prima cosa viene definita la connessione, verr\\xE0 utilizzata dai containers che vogliono collegarsi a traeik.\",mdx(\"br\",{parentName:\"p\"}),`\n`,\"Le tre porte esposte sono:\"),mdx(\"ul\",null,mdx(\"li\",{parentName:\"ul\"},\"8080 dedicata alla dashboard\"),mdx(\"li\",{parentName:\"ul\"},\"80 per le connessioni non sicure\"),mdx(\"li\",{parentName:\"ul\"},\"443 per le connessioni sicure\")),mdx(\"p\",null,\"I volumi invece:\"),mdx(\"ul\",null,mdx(\"li\",{parentName:\"ul\"},\"/var/run/docker.sock percorso sock docker installato sull'host\")),mdx(\"p\",null,\"Scritto il file \",mdx(\"inlineCode\",{parentName:\"p\"},\"docker-compose.yml\"),\" lanciamo il servizio con \",mdx(\"inlineCode\",{parentName:\"p\"},\"docker-compose up -d\"),\". In base alla connessione e potenza della macchina host ci pu\\xF2 volere anche qualche minuto. Quando sar\\xE0 tutto finito potrete raggiungere la dashboard da browser tramite http:\",\"\\\\\",\"\\\\\",\"\u003c ip della macchina su cui lo avete installato\u003e:8080.\",mdx(\"br\",{parentName:\"p\"}),`\n`,\"Saranno gi\\xE0 presenti un paio di servizi, tranquilli sono quelli interni che vengono creati dal proxy.\"),mdx(\"p\",null,\"Con questo la piccola guida \\xE8 finita.\",mdx(\"br\",{parentName:\"p\"}),`\n`,\"Spero di esservi stato utile.\"))}MDXContent.isMDXComponent=!0;\n","scope":{}},"post":{"slug":"2020-11-04-traefik-intro","title":"Traefik - Intro","date":"2020-11-10T12:50:05.227Z","description":"Introduzione a traefik","image":null,"tags":["self-hosted","proxy","traefik"],"content":"\nBuongiorno,  \noggi parleremo da [Traefik](https://doc.traefik.io/traefik/), un HTTP reverse proxy e load balancer.\n\n![architettura](https://doc.traefik.io/traefik/v1.7/img/architecture.png)\n\nIo lo sto utilizzando per rendere accessibili dall'esterno dei servizi hostati sul mio nas, come ad esempio Home Assistant e l'ottimo password manager Bitwarden (di cui probabilmente parlerò su questo blog).  \nSi integra perfettamente con docker, è infatti in grado di leggere automaticamente le impostazioni da un container tramite label.  \nVediamo ora come installarlo proprio tramite docker, più precisamente utilizzando docker-compose per semplificare le cose.\n\nPer prima cosa scriviamo il file di configurazione. Ci sono vari modi per configurare Traefik, via argomenti da linea di comando o via file traefik.yml, che è la strada che ho scelto io perché mi sembra più chiara. Ho commentato direttamente nel file le parti \"meno\" importanti.\n\n```yaml\n---\nglobal:\n  # Verifica la presenza di nuove versioni.\n  checkNewVersion: true\n\nentryPoints:\n  http:\n    address: :80\n    forwardedHeaders:\n      insecure: true\n    proxyProtocol:\n      insecure: true\n  https:\n    address: :443\n    forwardedHeaders:\n      insecure: true\n    proxyProtocol:\n      insecure: true\n\nproviders:\n  docker:\n    watch: true\n    exposedByDefault: false\n    endpoint: 'unix:///var/run/docker.sock'\n  file:\n    directory: '/etc/traefik/dynamic/'\n    watch: true\n\napi:\n  # Visualizza l'interfaccia web della dashboard e permetti connessioni non sicure.\n  dashboard: true\n  insecure: true\n\n# Salva il log nel percorso specificato, con livello DEBUG.\n# Ovviamente una volta impostato e verificato il corretto funzionamento si può abbassare il livello.\nlog:\n  filePath: '/shared/logs/traefik/traefik.log'\n  level: DEBUG\n\n# Salva il log delle chiamate nel percorso specificato.\n# E' possibile specificare dei filtri, nel mio caso solo le chiamate con condici di errore.\naccessLog:\n  filePath: '/shared/logs/traefik/access.log'\n  filters:\n    statusCodes: ['400-599']\n\n# Let's encrypt configuration\ncertificatesResolvers:\n  le:\n    acme:\n      email: \u003cemail\u003e\n      storage: /etc/traefik/acme/acme.json\n      tlschallenge: true\n```\n\nPer prima cosa vengono definiti gli entry points sono i punti di ingresso che può accettare il nostro proxy.  \nIo mi attendo delle connessioni dalla porta 80 e 443, è possibile aggiungere molte altre opzioni, ma per questo approfondimento vi rimando alla guida ufficiale.  \nI providers sono le risorse da cui è possibile accettare le configurazioni dinamiche, ossia i servizi, le routers e i middlewares.\n\n- docker: permette di creare delle configurazioni tramite le labels di un container.\n\n  - watch: true indica a traefik di rimanere in ascolto di modifiche sui containers, così non sarà necessario riavviare il server ad ogni modifica.\n  - exposedByDefault: false, bisogna specificare in un container se esporlo a traefik, altrimenti per ogni nuovo container in esecuzione verrà creato un servizio.\n  - endpoint: \"unix:///var/run/docker.sock\" il percorso del sock di docker per permettere la comunicazione con esso. Nel nostro caso sarà l'istanza di docker installata sul sistema host, come vedremo in seguito.\n\n- file: permette di creare le configurazioni tramite file o files yaml o toml.\n\n  - directory: \"/etc/traefik/dynamic/\" ho optato per indicare una cartella in modo da poter suddividere in modo più ordinato le impostazioni. E' possibili anche indicare un singolo file tramite l'impostazione `filename`.\n  - watch: true come sopra.\n\nL'altra parte molto importante del file è `certificatesResolvers`, cioè il modo in cui risolvere i certificati SSL.  \nNel mio caso utilizzo Let's Encrypt, un servizio gratuito che permette la generazione di certificati. Traefik integra già tutto il funzionamento basta utilizzare come provider `acme`. Le altre impostazioni sono molto semplici, una email valida per ricevere avvisi di scadenza dei certificati e il percorso dove salvare gli stessi.\n\nDefinita la configurazione base possiamo passare alla creazione del file docker-compose.yml per la creazione del container.\n\n```yaml\nversion: '3'\n\nnetworks:\n  trproxy:\n    driver: bridge\n\nservices:\n  traefik:\n    container_name: traefik\n    image: traefik:latest\n    restart: unless-stopped\n    networks:\n      - trproxy\n    environment:\n      - TZ:\"Europe/Rome\"\n    ports:\n      - 8080:8080\n      - 80:80\n      - 443:443\n    volumes:\n      - /var/run/docker.sock:/var/run/docker.sock:ro\n      - \u003cdir\u003e/traefik.yml:/etc/traefik/traefik.yml:ro\n      - \u003cdir\u003e/dynamic:/etc/traefik/dynamic/:ro\n      - \u003cdir\u003e/acme/acme.json:/etc/traefik/acme/acme.json\n      - \u003cdir\u003e/shared:/shared\n```\n\nPer prima cosa viene definita la connessione, verrà utilizzata dai containers che vogliono collegarsi a traeik.  \nLe tre porte esposte sono:\n\n- 8080 dedicata alla dashboard\n- 80 per le connessioni non sicure\n- 443 per le connessioni sicure\n\nI volumi invece:\n\n- /var/run/docker.sock percorso sock docker installato sull'host\n\nScritto il file `docker-compose.yml` lanciamo il servizio con `docker-compose up -d`. In base alla connessione e potenza della macchina host ci può volere anche qualche minuto. Quando sarà tutto finito potrete raggiungere la dashboard da browser tramite http:\\\\\\\\\u003c ip della macchina su cui lo avete installato\u003e:8080.  \nSaranno già presenti un paio di servizi, tranquilli sono quelli interni che vengono creati dal proxy.\n\nCon questo la piccola guida è finita.  \nSpero di esservi stato utile.\n"},"_superjson":{"values":{"post.date":["Date"],"post.image":["undefined"]}}},"__N_SSG":true},"page":"/posts/[slug]","query":{"slug":"2020-11-04-traefik-intro"},"buildId":"s30i1eaifIS6S8HLH4iJD","assetPrefix":".","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>