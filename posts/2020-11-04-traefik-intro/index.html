<!doctype html><html lang=it>
<head>
<title>Traefik - Intro :: T-Dev</title>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content="Introduzione a traefik">
<meta name=keywords content>
<meta name=robots content="noodp">
<link rel=canonical href=https://simon020286.github.io/posts/2020-11-04-traefik-intro/>
<link rel=stylesheet href=https://simon020286.github.io/assets/style.css>
<link rel=stylesheet href=https://simon020286.github.io/assets/green.css>
<link rel=apple-touch-icon href=https://simon020286.github.io/img/apple-touch-icon-192x192.png>
<link rel="shortcut icon" href=https://simon020286.github.io/images/favicon.ico>
<meta name=twitter:card content="summary">
<meta property="og:locale" content="it">
<meta property="og:type" content="article">
<meta property="og:title" content="Traefik - Intro">
<meta property="og:description" content="Introduzione a traefik">
<meta property="og:url" content="https://simon020286.github.io/posts/2020-11-04-traefik-intro/">
<meta property="og:site_name" content="T-Dev">
<meta property="og:image" content="https://simon020286.github.io/images/favicon.ico">
<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">
<meta property="article:published_time" content="2020-11-10 12:50:05.227 +0000 UTC">
</head>
<body class=green>
<div class="container center headings--one-size">
<header class=header>
<div class=header__inner>
<div class=header__logo>
<a href=/>
<div class=logo>
T-Dev
</div>
</a>
</div>
<div class=menu-trigger>menu</div>
</div>
<nav class=menu>
<ul class="menu__inner menu__inner--desktop">
<li><a href=/>Home</a></li>
<li><a href=/posts>All posts</a></li>
<li><a href=/tags>Tags</a></li>
</ul>
<ul class="menu__inner menu__inner--mobile">
<li><a href=/>Home</a></li>
<li><a href=/posts>All posts</a></li>
<li><a href=/tags>Tags</a></li>
</ul>
</nav>
</header>
<div class=content>
<div class=post>
<h1 class=post-title>
<a href=https://simon020286.github.io/posts/2020-11-04-traefik-intro/>Traefik - Intro</a></h1>
<div class=post-meta>
<span class=post-date>
2020-11-10
</span>
</div>
<span class=post-tags>
#<a href=https://simon020286.github.io/tags/self-hosted/>self-hosted</a>&nbsp;
#<a href=https://simon020286.github.io/tags/proxy/>proxy</a>&nbsp;
#<a href=https://simon020286.github.io/tags/traefik/>traefik</a>&nbsp;
</span>
<div class=post-content><div>
<p>Buongiorno,<br>
oggi parleremo da <a href=https://doc.traefik.io/traefik/>Traefik</a>, un HTTP reverse proxy e load balancer.</p>
<p><img src=https://doc.traefik.io/traefik/v1.7/img/architecture.png alt=architettura></p>
<p>Io lo sto utilizzando per rendere accessibili dall&rsquo;esterno dei servizi hostati sul mio nas, come ad esempio Home Assistant e l&rsquo;ottimo password manager Bitwarden (di cui probabilmente parlerò su questo blog).<br>
Si integra perfettamente con docker, è infatti in grado di leggere automaticamente le impostazioni da un container tramite label.<br>
Vediamo ora come installarlo proprio tramite docker, più precisamente utilizzando docker-compose per semplificare le cose.</p>
<p>Per prima cosa scriviamo il file di configurazione. Ci sono vari modi per configurare Traefik, via argomenti da linea di comando o via file traefik.yml, che è la strada che ho scelto io perché mi sembra più chiara. Ho commentato direttamente nel file le parti &ldquo;meno&rdquo; importanti.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>---

<span style=color:#f92672>global</span>:
  <span style=color:#75715e># Verifica la presenza di nuove versioni.</span>
  <span style=color:#f92672>checkNewVersion</span>: <span style=color:#66d9ef>true</span>

<span style=color:#f92672>entryPoints</span>:
  <span style=color:#f92672>http</span>:
    <span style=color:#f92672>address</span>: :<span style=color:#ae81ff>80</span>
    <span style=color:#f92672>forwardedHeaders</span>:
      <span style=color:#f92672>insecure</span>: <span style=color:#66d9ef>true</span>
    <span style=color:#f92672>proxyProtocol</span>:
      <span style=color:#f92672>insecure</span>: <span style=color:#66d9ef>true</span>
  <span style=color:#f92672>https</span>:
    <span style=color:#f92672>address</span>: :<span style=color:#ae81ff>443</span>
    <span style=color:#f92672>forwardedHeaders</span>:
      <span style=color:#f92672>insecure</span>: <span style=color:#66d9ef>true</span>
    <span style=color:#f92672>proxyProtocol</span>:
      <span style=color:#f92672>insecure</span>: <span style=color:#66d9ef>true</span>

<span style=color:#f92672>providers</span>:
  <span style=color:#f92672>docker</span>:
    <span style=color:#f92672>watch</span>: <span style=color:#66d9ef>true</span>
    <span style=color:#f92672>exposedByDefault</span>: <span style=color:#66d9ef>false</span>
    <span style=color:#f92672>endpoint</span>: <span style=color:#e6db74>&#34;unix:///var/run/docker.sock&#34;</span>
  <span style=color:#f92672>file</span>:
    <span style=color:#f92672>directory</span>: <span style=color:#e6db74>&#34;/etc/traefik/dynamic/&#34;</span>
    <span style=color:#f92672>watch</span>: <span style=color:#66d9ef>true</span>
    
<span style=color:#f92672>api</span>:
  <span style=color:#75715e># Visualizza l&#39;interfaccia web della dashboard e permetti connessioni non sicure.</span>
  <span style=color:#f92672>dashboard</span>: <span style=color:#66d9ef>true</span>
  <span style=color:#f92672>insecure</span>: <span style=color:#66d9ef>true</span>
 
<span style=color:#75715e># Salva il log nel percorso specificato, con livello DEBUG.</span>
<span style=color:#75715e># Ovviamente una volta impostato e verificato il corretto funzionamento si può abbassare il livello.</span>
<span style=color:#f92672>log</span>:
  <span style=color:#f92672>filePath</span>: <span style=color:#e6db74>&#34;/shared/logs/traefik/traefik.log&#34;</span>
  <span style=color:#f92672>level</span>: <span style=color:#ae81ff>DEBUG</span>

<span style=color:#75715e># Salva il log delle chiamate nel percorso specificato.</span>
<span style=color:#75715e># E&#39; possibile specificare dei filtri, nel mio caso solo le chiamate con condici di errore.</span>
<span style=color:#f92672>accessLog</span>:
  <span style=color:#f92672>filePath</span>: <span style=color:#e6db74>&#34;/shared/logs/traefik/access.log&#34;</span>
  <span style=color:#f92672>filters</span>:
    <span style=color:#f92672>statusCodes</span>: [<span style=color:#e6db74>&#34;400-599&#34;</span>]

<span style=color:#75715e># Let&#39;s encrypt configuration</span>
<span style=color:#f92672>certificatesResolvers</span>:
  <span style=color:#f92672>le</span>:
    <span style=color:#f92672>acme</span>:
      <span style=color:#f92672>email</span>: <span style=color:#ae81ff>&lt;email&gt;</span>
      <span style=color:#f92672>storage</span>: <span style=color:#ae81ff>/etc/traefik/acme/acme.json</span>
      <span style=color:#f92672>tlschallenge</span>: <span style=color:#66d9ef>true</span>
</code></pre></div><p>Per prima cosa vengono definiti gli entry points sono i punti di ingresso che può accettare il nostro proxy.<br>
Io mi attendo delle connessioni dalla porta 80 e 443, è possibile aggiungere molte altre opzioni, ma per questo approfondimento vi rimando alla guida ufficiale.<br>
I providers sono le risorse da cui è possibile accettare le configurazioni dinamiche, ossia i servizi, le routers e i middlewares.</p>
<ul>
<li>
<p>docker: permette di creare delle configurazioni tramite le labels di un container.</p>
<ul>
<li>watch: true indica a traefik di rimanere in ascolto di modifiche sui containers, così non sarà necessario riavviare il server ad ogni modifica.</li>
<li>exposedByDefault: false, bisogna specificare in un container se esporlo a traefik, altrimenti per ogni nuovo container in esecuzione verrà creato un servizio.</li>
<li>endpoint: &ldquo;unix:///var/run/docker.sock&rdquo; il percorso del sock di docker per permettere la comunicazione con esso. Nel nostro caso sarà l&rsquo;istanza di docker installata sul sistema host, come vedremo in seguito.</li>
</ul>
</li>
<li>
<p>file: permette di creare le configurazioni tramite file o files yaml o toml.</p>
<ul>
<li>directory: &ldquo;/etc/traefik/dynamic/&rdquo; ho optato per indicare una cartella in modo da poter suddividere in modo più ordinato le impostazioni. E' possibili anche indicare un singolo file tramite l&rsquo;impostazione <code>filename</code>.</li>
<li>watch: true come sopra.</li>
</ul>
</li>
</ul>
<p>L&rsquo;altra parte molto importante del file è <code>certificatesResolvers</code>, cioè il modo in cui risolvere i certificati SSL.<br>
Nel mio caso utilizzo Let&rsquo;s Encrypt, un servizio gratuito che permette la generazione di certificati. Traefik integra già tutto il funzionamento basta utilizzare come provider <code>acme</code>. Le altre impostazioni sono molto semplici, una email valida per ricevere avvisi di scadenza dei certificati e il percorso dove salvare gli stessi.</p>
<p>Definita la configurazione base possiamo passare alla creazione del file docker-compose.yml per la creazione del container.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>version</span>: <span style=color:#e6db74>&#34;3&#34;</span>

<span style=color:#f92672>networks</span>:
  <span style=color:#f92672>trproxy</span>:
    <span style=color:#f92672>driver</span>: <span style=color:#ae81ff>bridge</span>

<span style=color:#f92672>services</span>:
  <span style=color:#f92672>traefik</span>:
    <span style=color:#f92672>container_name</span>: <span style=color:#ae81ff>traefik</span>
    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>traefik:latest</span>
    <span style=color:#f92672>restart</span>: <span style=color:#ae81ff>unless-stopped</span>
    <span style=color:#f92672>networks</span>:
      - <span style=color:#ae81ff>trproxy</span>
    <span style=color:#f92672>environment</span>:
      - <span style=color:#ae81ff>TZ:&#34;Europe/Rome&#34;</span>
    <span style=color:#f92672>ports</span>:
      - <span style=color:#ae81ff>8080</span>:<span style=color:#ae81ff>8080</span>
      - <span style=color:#ae81ff>80</span>:<span style=color:#ae81ff>80</span>
      - <span style=color:#ae81ff>443</span>:<span style=color:#ae81ff>443</span>
    <span style=color:#f92672>volumes</span>:
      - <span style=color:#ae81ff>/var/run/docker.sock:/var/run/docker.sock:ro</span>
      - <span style=color:#ae81ff>&lt;dir&gt;/traefik.yml:/etc/traefik/traefik.yml:ro</span>
      - <span style=color:#ae81ff>&lt;dir&gt;/dynamic:/etc/traefik/dynamic/:ro</span>
      - <span style=color:#ae81ff>&lt;dir&gt;/acme/acme.json:/etc/traefik/acme/acme.json</span>
      - <span style=color:#ae81ff>&lt;dir&gt;/shared:/shared</span>
</code></pre></div><p>Per prima cosa viene definita la connessione, verrà utilizzata dai containers che vogliono collegarsi a traeik.<br>
Le tre porte esposte sono:</p>
<ul>
<li>8080 dedicata alla dashboard</li>
<li>80 per le connessioni non sicure</li>
<li>443 per le connessioni sicure</li>
</ul>
<p>I volumi invece:</p>
<ul>
<li>/var/run/docker.sock percorso sock docker installato sull&rsquo;host</li>
</ul>
<p>Scritto il file <code>docker-compose.yml</code> lanciamo il servizio con <code>docker-compose up -d</code>. In base alla connessione e potenza della macchina host ci può volere anche qualche minuto. Quando sarà tutto finito potrete raggiungere la dashboard da browser tramite http:&lt;ip della macchina su cui lo avete installato>:8080.<br>
Saranno già presenti un paio di servizi, tranquilli sono quelli interni che vengono creati dal proxy.</p>
<p>Con questo la piccola guida è finita.<br>
Spero di esservi stato utile.</p>
</div></div>
<div class=pagination>
<div class=pagination__title>
<span class=pagination__title-h>Read other posts</span>
<hr>
</div>
<div class=pagination__buttons>
<span class="button previous">
<a href=https://simon020286.github.io/posts/2020-11-12-traefik-middlewares/>
<span class=button__icon>←</span>
<span class=button__text>Traefik - Middlewares</span>
</a>
</span>
<span class="button next">
<a href=https://simon020286.github.io/posts/update-ddns/>
<span class=button__text>Update Ddns</span>
<span class=button__icon>→</span>
</a>
</span>
</div>
</div>
</div>
</div>
<footer class=footer>
<div class=footer__inner>
<div class=copyright>
<span>© 2021 Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span>
</div>
</div>
</footer>
<script src=https://simon020286.github.io/assets/main.js></script>
<script src=https://simon020286.github.io/assets/prism.js></script>
</div>
</body>
</html>